<html>
  <head>
    <title>Beginner's Luck Online Gaming &amp; Casino</title>
    <link rel="icon" href="https://cdn.glitch.global/2ef0ca36-d8d7-4c06-b231-374cc15fda3a/favicon.png?v=1661169643668" />
    <link rel="stylesheet" href="../css/glitch.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/flow.css" />
    <link rel="stylesheet" href="../css/blackjack.css" />
    
    <script type="text/javascript" src="https://assets.pingone.com/davinci/latest/davinci.js" ></script>
    <!--  Script containing method to render DaVinci Flow    -->
    <script type="text/javascript" src="../scripts/loadwidget.js" defer></script>
    <!--  Script containing method to render DaVinci Flow    -->
    <script type="text/javascript" src="../scripts/blackjack.js" defer></script>
    <!-- Script to retrieve jackpot data  -->
    <script src="../scripts/jackpot-api.js"></script>
    
    <script type="text/javascript">
      // Placeholder for user country
      let COUNTRY_CODE = ""
      let blackjackTimer
      
      // Initialize click handlers      
      function initialize() {
        // Retrieve the modal popup div
        var modalPopup = document.getElementById("modalPopup");

        // Create 'Register Now' button click handler
        var registerBtn = document.getElementById("btn-register");
        registerBtn.onclick = function() {
          // Display the modal popup div
          modalPopup.style.display = "block";
          loadRegistrationFlow()
        }
        
        var signinBtn = document.getElementById("btn-signin");
        signinBtn.onclick = function() {
          // Display the modal popup div
          modalPopup.style.display = "block";
          loadSignInFlow()
        }

        // Create the 'Close' 'X' button click handler
        var closeBtn = document.getElementById("closeBtn");
        closeBtn.onclick = function() {
          closeModalPopup();  
        }

        /* Create the Window click handle that will close the popup
           if the user clicks anywhere outside of it */
        window.onclick = function(event) {
          if (event.target === modalPopup) {
           closeModalPopup();
          }
        }
      }
      
      // Close the modal popup
      function closeModalPopup() {
        // Hide the modal popup div
        modalPopup.style.display = "none";
        // Clean up Davinci widget
        davinci.cleanup(document.getElementById("flow-widget"));        
      }  
      
      // Load DaVinci Registration Flow
      function loadRegistrationFlow() {    
        const policyId = "9a25d731af9d7e1c4266b4a25306fe3c"
        const divComponent = "flow-widget"
        let flowInputData = {"countryCode": COUNTRY_CODE}
        loadwidget(policyId, divComponent, flowInputData)
      }
      
      function loadJackpotData() {
        //load jackpot data
        const policyId = "d0eeb662d49c4a8a1233b5286f8bcde4"
        fetchJackpotData(policyId, loadJackpotSuccess)
      }
      
      function loadSignInFlow() {
        const policyId = "23770824877d3de2d61aae2ba2833f61"
        const divComponent = "flow-widget"
        loadwidget(policyId, divComponent)
      }

       function loadJackpotSuccess(data) {
        const element = document.getElementById('jackpot')
        element.innerHTML = `
              <p class="jackpot"><strong>Get in on the action!</strong><br/>
              This week's ${data.jackpotCountryEmoji} jackpot is ${data.jackpot_currency}${data.jackpot_amount.toLocaleString()}</p>` 
        
        COUNTRY_CODE = data.jackpot_country_code
        document.getElementById('btn-register').disabled = false 
       }
      
      function initializeBlackjack (tallies) {
         const policyId = "dfffcf4d54d9e90e069723c1c4d022ab"
        const divComponent = "div-blackjack"
        
        loadBlackjackWidget(policyId, divComponent,blackjackSuccessCallback, tallies)
      }
      
      function blackjackSuccessCallback(response) {
      
       let  tallies = {"dealerTally": response.dealerTally, "playerTally": response.playerTally, "pushTally": response.pushTally }
      
        if (response.action === "PLAY_AGAIN") {
          let game = document.getElementById("div-blackjack")
          davinci.cleanup(game);   
           initializeBlackjack(tallies);

        }
      }
      
      function showGame() {
        console.log('timer')
         let game = document.getElementById("div-blackjack")
          let placeholder = document.getElementById("table-holder");
        game.style.visibility = "visible"
          placeholder.style.display = "none";
        clearInterval(blackjackTimer)
      }
    </script>
   
  </head>
  
<body onload="initializeBlackjack()" >    
    <h3 style="color:red">
      Under Construction - Expect Issues :) 
  </h3>
    <div class="top-bar">
        <table class="content-holder">
          <tr>
            <td><img class="main-site-logo"/></td>
            <td ><h1>Beginner's Luck Online Gaming &amp; Casino</h1> </td>
            <td>
              <button id="btn-signin" onclick="alert('Coming soon. Implemented but not yet integrated')">
                <i class="fa fa-sign-in" aria-hidden="true"></i> Sign On
              </button>
            </td>
          </tr>          
        </table>
    </div> 
    <div id="div-blackjack" class="blackjack-table" >
      
    </div>

    <hr/>
    <div class="pingenablement">&copy; 2022 Ping Identity - DaVinci Enablement Session Material</div>
  
    <!-- PopUp Modal Dialog where the DaVinci Flow will be placed -->
    <div id="modalPopup" class="modal">
      <div class="modal-content">
        <div id="closeBtn" class="close">&times;</div>
        <div id="flow-widget" class="flow-widget"></div>
      </div>
    </div>
    <div style="width:600px">
      
      <strong>Issue Tracker:</strong>
      <ul>
       
        <li>- Game should end if dealer has blackjack on first 2 cards (with Ace showing)</li>
       
      </ul>
      <br/>
      <strong>Enhancment Tracker:</strong>
      <ul>
        <li>- Double Down</li>
        <li>- Split pairs</li>
        <li>- Wagering</li>
      </ul>
      <br/>
      <strong>Fixes In Testing:</strong>
      <ul>
         <li>- Sometimes the dealer will stop drawing cards</li>
         <li>- A push is registering as a dealer win</li>
      </ul>
      
  </div>
    
  </body>
</html>
